[{"create-time":1611399290250,"title":"Wikipedia SmartBlocks","children":[{"string":"Wikipedia SmartBlocks v0.4","create-time":1611481677322,"heading":2,"uid":"JJ5ir8rYr","edit-time":1612499799870,":edit/user":{":user/uid":"bk2zsgVL3tOkt71vQJqzcUAFqJi2"}},{"string":"Configuration:","create-time":1611481687996,"heading":3,"children":[{"string":"#42Setting WikiExtractSentences 6","create-time":1611481694978,"refs":[{"uid":"IV-D0JoYF"}],"children":[{"string":"**Instructions:**","create-time":1611218358740,"children":[{"string":"Replace the number after WikiExtractSentences above with the number of sentences from the extract that you wish to display. (default = 6)","create-time":1611218336546,"uid":"j43v-WadH","edit-time":1611399290256}],"uid":"_kbj8PsPI","edit-time":1611399290256}],"uid":"orMgaVvmm","edit-time":1611481696220,":block/refs":[{":block/uid":"IV-D0JoYF"}]},{"string":"#42Setting WikiMode <Mode>","create-time":1611445715881,":block/refs":[{":block/uid":"IV-D0JoYF"}],"refs":[{"uid":"IV-D0JoYF"}],"children":[{"string":"**Instructions:**","create-time":1611447000605,"children":[{"string":"There are two options. If you choose Prompt, the SmartBlock will pop up a prompt asking you to define the search query. If you choose Page Title, the SmartBlock will obtain the title of the page in Roam Research and search Wikipedia without further intervention.","create-time":1611447040744,"uid":"JYc5VxWq1","edit-time":1611447108458},{"string":"Replace the <Mode> in the WikiMode setting above with either Page Title or Prompt.","create-time":1611447006548,"uid":"OLl-MAcgt","edit-time":1611447039010}],"uid":"X-olBEEw6","edit-time":1611447005537}],"uid":"kGY2VCO0G","edit-time":1612499881923,":edit/user":{":user/uid":"bk2zsgVL3tOkt71vQJqzcUAFqJi2"}},{"string":"Copy the css below into your [[roam/css]] page:","create-time":1611218661473,"refs":[{"uid":"WGArFgd3-"}],"children":[{"string":"```css\n/* Horizontal / Grid layouts */\n.roam-block-container[data-page-links*=\"rm-horizontal\"] .rm-block-children {\n  display: flex;\n  flex-direction: row;\n}\n.roam-block-container[data-page-links*=\"rm-horizontal\"] .rm-block__controls {\n  //display: none;\n}\n.roam-block-container[data-page-links*=\"rm-horizontal\"] .rm-block-children {\n  display: flex;\n  flex-direction: row;\n}\n.roam-block-container[data-page-links*=\"rm-grid\"] .rm-block-children {\n  display: grid;\n  grid-template-columns: repeat( auto-fit, minmax(150px, 1fr) );\n}\n.roam-block-container[data-page-links*=\"rm-grid\"] .rm-block-children  .rm-block__controls {\n  //display: none;\n}\n.roam-block-container[data-page-links*=\"rm-hide\"] span.rm-page-ref[data-tag*=\"rm\"] \n{\n  display: none;\n}\n/* Horizontal / Grid layouts */```","create-time":1611218760167,"uid":"xIXY4e_6b","edit-time":1611399290256}],"uid":"KUlLUT35A","edit-time":1611399290256,":block/refs":[{":block/uid":"WGArFgd3-"}]}],"uid":"SJS8glxpk","edit-time":1611481694994},{"string":"---","create-time":1611218329443,"uid":"-6kNzbM7W","edit-time":1611399290257},{"string":"#42SmartBlock Wikipedia ","create-time":1611218871536,"refs":[{"uid":"Z9KTSev0J"}],"children":[{"string":"<%NOBLOCKOUTPUT%><%JAVASCRIPTASYNC: ```javascript\nlet wikiMode = await roam42.settings.get('WikiMode');\nvar query = '';\nvar pageTitle = null;\nif(document.activeElement.closest('.sidebar-content')!=null) {\n    if(document.activeElement.closest('.rm-sidebar-outline').querySelector('h1.rm-title-display'))\n        pageTitle = document.activeElement.closest('.rm-sidebar-outline').querySelector('h1.rm-title-display').innerText;\n    else if(document.activeElement.closest('.rm-sidebar-outline').querySelector('.rm-zoom-item-content'))\n        pageTitle = document.activeElement.closest('.rm-sidebar-outline').querySelector('.rm-zoom-item-content').innerText;\n} else if (document.activeElement.closest('.roam-article')!=null) {\n    if(document.activeElement.closest('.roam-log-page'))\n        pageTitle = document.activeElement.closest('.roam-log-page').querySelector('.rm-title-display').innerText;\n    if(pageTitle==null && document.querySelector('.rm-title-display'))\n        pageTitle = document.querySelector('.rm-title-display').innerText;\n}\n\nif (wikiMode == \"Page Title\") {\n  \tquery = pageTitle;\n} else if (wikiMode == \"Prompt\") {\n    var prompt = window.prompt(\"Please enter your query\", \"\"+pageTitle+\"\");\n    query = prompt;\n} else {\n  \talert(\"Please enter either Page Title or Prompt in Settings\");\n  \treturn;\n}\n\nvar settings = {\n    \"url\": \"https://en.wikipedia.org/w/api.php?action=query&format=json&list=search&srsearch=\"+query+\"&origin=*\",\n    \"method\": \"GET\",\n    \"timeout\": 0\n};\n\nroam42.common.setEmptyNodeValue(document.activeElement, \"**Wikipedia Summary:** #rm-hide #rm-horizontal\");\nawait roam42KeyboardLib.pressEnter(200);\nawait roam42KeyboardLib.pressTab(150);\n\n$.ajax(settings).done(function (response) {\n    //console.log(response);\n    var jsonWiki = JSON.stringify(response);\n    var wikiSearch = JSON.parse(jsonWiki);\n    var string = \"Which result do you mean?\";\n    string += \" {{\"+wikiSearch.query.search[0].title+\":42SmartBlock:zz Wikipedia Selected:pageTitle=\"+wikiSearch.query.search[0].title+\",pageID=\"+wikiSearch.query.search[0].pageid+\"}}\";\n    string += \" {{\"+wikiSearch.query.search[1].title+\":42SmartBlock:zz Wikipedia Selected:pageTitle=\"+wikiSearch.query.search[1].title+\",pageID=\"+wikiSearch.query.search[1].pageid+\"}}\";\n    string += \" {{\"+wikiSearch.query.search[2].title+\":42SmartBlock:zz Wikipedia Selected:pageTitle=\"+wikiSearch.query.search[2].title+\",pageID=\"+wikiSearch.query.search[2].pageid+\"}}\";\n    string += \" {{\"+wikiSearch.query.search[3].title+\":42SmartBlock:zz Wikipedia Selected:pageTitle=\"+wikiSearch.query.search[3].title+\",pageID=\"+wikiSearch.query.search[3].pageid+\"}}\";\n    string += \" {{\"+wikiSearch.query.search[4].title+\":42SmartBlock:zz Wikipedia Selected:pageTitle=\"+wikiSearch.query.search[4].title+\",pageID=\"+wikiSearch.query.search[4].pageid+\"}}\";\n    \n    let txtarea = document.activeElement;\n    var setValue = Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype, 'value').set;\n    setValue.call(txtarea, string);\n    const inputEvent = new Event('input', { bubbles: true });\n    txtarea.dispatchEvent(inputEvent);\n});``` %>","create-time":1610965441743,"uid":"Gf_el9bCg","edit-time":1612499922272,":edit/user":{":user/uid":"bk2zsgVL3tOkt71vQJqzcUAFqJi2"}}],"uid":"JVePPQkY9","edit-time":1611399290257,":block/refs":[{":block/uid":"Z9KTSev0J"}]},{"string":"#42SmartBlock zz Wikipedia Selected <%HIDE%>","create-time":1611399316757,"refs":[{"uid":"Z9KTSev0J"}],"children":[{"string":"<%JA: ```javascript\nlet pageTitle = roam42.smartBlocks.activeWorkflow.vars[\"pageTitle\"];\nlet pageID = roam42.smartBlocks.activeWorkflow.vars[\"pageID\"];\nlet wikiExtractSentences = await roam42.settings.get('WikiExtractSentences');\nvar url = \"https://en.wikipedia.org/w/api.php?format=json&action=query&exintro&explaintext&exsentences=\"+wikiExtractSentences+\"&exlimit=max&origin=*&prop=info|extracts&inprop=url&pageids=\"+pageID+\"\";\nvar url1 = \"https://en.wikipedia.org/w/api.php?action=query&prop=pageimages&format=json&piprop=original&titles=\"+pageTitle+\"&format=json&formatversion=2&origin=*\";\n\ndocument.activeElement.value = 'Loading...';\n\nconst getExtract = new Promise((resolve, reject) => {\n    const settings = { \"url\": url, \"type\": \"GET\", \"timeout\": 0 };\n  \t$.ajax(settings).done(function (response) {\n      \tconsole.log(response);\n        var jsonWiki = JSON.stringify(response);\n        var wiki = JSON.parse(jsonWiki);\n        var string = \"\" + wiki.query.pages[pageID].extract + \"\";\n        var url = \"\" + wiki.query.pages[pageID].canonicalurl + \"\";\n      \tvar extractResults = {string, url};\n      \tresolve(extractResults);\n    })\n});\n\nconst getImage = new Promise((resolve, reject) => {\n    const settings1 = { \"url\": url1, \"type\": \"GET\", \"timeout\": 0 };\n    $.ajax(settings1).done(function (response) {\n          //console.log(response);\n        var jsonWiki = JSON.stringify(response);\n        var wikiImages = JSON.parse(jsonWiki);\n        if (wikiImages.query.pages[0].hasOwnProperty('original')) {\n            var string1 = \"![](\"+wikiImages.query.pages[0].original.source+\")\";\n            resolve(string1);\n        } else {\n            resolve(\"No Image Available\");\n        }\n    })\n});\n\nPromise.allSettled([getExtract, getImage])\n  .then(async results => {\n      //console.log(results);\n      let txtarea = document.activeElement;\n      var setValue = Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype, 'value').set;\n      if (results[0].status == \"fulfilled\") {\n        setValue.call(txtarea, results[0].value.string);\n      }\n      else {\n        setValue.call(txtarea, \"Call to Wikipedia API did not return results\");\n      }\n      const inputEvent = new Event('input', { bubbles: true });\n      txtarea.dispatchEvent(inputEvent);\n      await roam42KeyboardLib.pressEnter(200);\n      let txtarea1 = document.activeElement;\n      var setValue1 = Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype, 'value').set;\n      if (results[1].status == \"fulfilled\") {\n        setValue1.call(txtarea1, results[1].value);\n      }\n      else {\n        setValue1.call(txtarea1, \"Call to Wikipedia API did not return results\");\n      }\n      txtarea1.dispatchEvent(inputEvent);\n      await roam42KeyboardLib.pressEnter(200);\n      await roam42KeyboardLib.pressEnter(200);\n      let txtarea2 = document.activeElement;\n      var setValue2 = Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype, 'value').set;\n      if (results[0].status == \"fulfilled\") {\n        var source = \"Source: \"+results[0].value.url;\n      }\n      else {\n        var source = \"Call to Wikipedia API did not return results\";\n      }\n      setValue2.call(txtarea2, source);\n      txtarea2.dispatchEvent(inputEvent);\n  })\n  .catch(console.error)\n  .finally(() => console.log('Finished getting Wikipedia Data'));``` %><%NOBLOCKOUTPUT%>","create-time":1611399316757,"uid":"vFNPlRfxB","edit-time":1612499993228,":edit/user":{":user/uid":"bk2zsgVL3tOkt71vQJqzcUAFqJi2"}}],"uid":"MK55EO038","edit-time":1611399316757,":block/refs":[{":block/uid":"Z9KTSev0J"}]}],"uid":"9e3UvidD5","edit-time":1611399290270}]
